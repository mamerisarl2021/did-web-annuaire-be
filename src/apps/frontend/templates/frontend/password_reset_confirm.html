{% extends "frontend/base.html" %}
{% block title %}New Password — AnnuaireDID{% endblock %}

{% block body %}
<div class="auth-page">
  <div class="card">
    <div class="brand">
      <h1><span>Annuaire</span>DID</h1>
      <p>Set your new password</p>
    </div>

    <div id="alert-box"></div>

    <div id="form-section">
      <form onsubmit="handleConfirm(event)">
        <div class="form-group">
          <label for="new_password">New Password <span class="required">*</span></label>
          <input id="new_password" type="password" class="form-input" placeholder="Minimum 8 characters" required>
        </div>
        <div class="form-group">
          <label for="confirm_password">Confirm Password <span class="required">*</span></label>
          <input id="confirm_password" type="password" class="form-input" placeholder="Repeat password" required>
        </div>
        <button type="submit" id="submit-btn" class="btn btn-primary">
          <span class="btn-label">Reset Password</span>
          <span class="htmx-indicator spinner"></span>
        </button>
      </form>
    </div>

    <div id="done-section" class="hidden text-center">
      <div class="success-icon">✓</div>
      <h2>Password Reset</h2>
      <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">
        Your password has been updated. You can now sign in.
      </p>
      <a href="{% url 'frontend:login' %}" class="btn btn-primary mt-3">Sign In</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const RESET_TOKEN = "{{ token|escapejs }}";

  async function handleConfirm(e) {
    e.preventDefault();
    const btn = document.getElementById("submit-btn");
    const pw = document.getElementById("new_password").value;
    const confirm = document.getElementById("confirm_password").value;

    clearAlert("alert-box");

    if (pw.length < 8) {
      showAlert("alert-box", "Password must be at least 8 characters.");
      return;
    }
    if (pw !== confirm) {
      showAlert("alert-box", "Passwords do not match.");
      return;
    }

    setLoading(btn, true);

    try {
      await Auth.passwordResetConfirm(RESET_TOKEN, pw);
      document.getElementById("form-section").classList.add("hidden");
      document.getElementById("done-section").classList.remove("hidden");
    } catch (err) {
      showAlert("alert-box", err.detail || "Invalid or expired reset token.");
    } finally {
      setLoading(btn, false);
    }
  }
</script>
{% endblock %}
