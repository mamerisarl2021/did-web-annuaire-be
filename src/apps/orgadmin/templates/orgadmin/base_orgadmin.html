{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard{% endblock %} ‚Äî AnnuaireDID</title>
    <link rel="stylesheet" href="{% static 'orgadmin/css/orgadmin.css' %}">
    <link rel="stylesheet" href="{% static 'orgadmin/css/certificates.css' %}">
    <link rel="stylesheet" href="{% static 'orgadmin/css/documents.css' %}">
    <script src="https://unpkg.com/htmx.org@2.0.8"></script>
</head>
<body class="oa-body">
<div class="oa-shell">

    <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <aside class="oa-sidebar">
        <div class="oa-sidebar-brand">
            <h1><span>Annuaire</span>DID</h1>
        </div>

        <div class="oa-sidebar-org">
            <div class="org-name" id="sidebar-org-name">‚Äî</div>
            <div class="org-slug" id="sidebar-org-slug">‚Äî</div>
            <div class="org-badge" id="sidebar-org-badge">‚Äî</div>
        </div>

        <ul class="oa-nav">
            <li>
                <a href="/workspace/" class="{% if active_page == 'dashboard' %}active{% endif %}">
                    <span class="icon">üìä</span> Dashboard
                </a>
            </li>
            <li>
                <a href="/workspace/members/" class="{% if active_page == 'members' %}active{% endif %}">
                    <span class="icon">üë•</span> Members
                    <span class="oa-nav-count" id="nav-member-count">‚Äî</span>
                </a>
            </li>
            <li>
                <a href="/workspace/documents/" class="{% if active_page == 'documents' %}active{% endif %}">
                    <span class="icon">üìÑ</span> DID Documents
                    <span class="oa-nav-count" id="nav-doc-count">‚Äî</span>
                </a>
            </li>

            <li>
                <a href="/workspace/certificates/" class="{% if active_page == 'certificates' %}active{% endif %}">
                    <span class="icon">üîê</span> Certificates
                    <span class="oa-nav-count" id="nav-cert-count">‚Äî</span>
                </a>
            </li>

            <li>
                <a href="/workspace/settings/" class="{% if active_page == 'settings' %}active{% endif %}">
                    <span class="icon">‚öôÔ∏è</span> Settings
                </a>
            </li>
        </ul>

        <div class="oa-sidebar-footer">
            <div class="oa-user-name" id="sidebar-user-name">‚Äî</div>
            <div class="oa-user-role" id="sidebar-user-role">‚Äî</div>
            <button class="oa-btn-logout" onclick="handleOALogout()">Logout</button>
        </div>
    </aside>

    <!-- ‚îÄ‚îÄ Main ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <main class="oa-main">
        {% block content %}{% endblock %}
    </main>
</div>

<script src="{% static 'frontend/js/auth.js' %}"></script>
<script src="{% static 'orgadmin/js/orgadmin.js' %}"></script>
<script>
    // Guard
    if (!Auth.isLoggedIn()) {
        window.location.href = "/login/";
    }

    // Load sidebar context
    (async function initSidebar() {
        try {
            const user = await Auth.me();


            document.getElementById("sidebar-user-name").textContent = user.full_name || "User";

            // Load orgs and pick the first (or current)
            const orgs = await OA.listOrgs();

            if (orgs.length === 0) {
                document.getElementById("sidebar-org-name").textContent = "No organization";
                document.getElementById("sidebar-org-slug").textContent = "‚Äî";
                return;
            }

            let org = getCurrentOrg();
            if (!org || !orgs.find(o => o.id === org.id)) {
                org = orgs[0];
                setCurrentOrg(org);
            }

            document.getElementById("sidebar-org-name").textContent = org.name;
            document.getElementById("sidebar-org-slug").textContent = org.slug;
            document.getElementById("sidebar-org-badge").textContent = org.status === "APPROVED" ? "Active" : org.status;
            document.getElementById("sidebar-user-role").textContent =
                org.member_count !== undefined ? `${org.member_count} members` : "";

            // Nav counts
            if (org.member_count !== undefined) {
                document.getElementById("nav-member-count").textContent = org.member_count;
            }
            if (org.document_count !== undefined) {
                document.getElementById("nav-doc-count").textContent = org.document_count;
            }
            if (org.certificate_count !== undefined) {
                document.getElementById("nav-cert-count").textContent = org.certificate_count;
            }

        } catch (err) {
            if (err && err.status === 401) {
                Auth.clearTokens();
                window.location.href = "/login/";
            }
        }
    })();

    async function handleOALogout() {
        try {
            await Auth.logout();
        } catch {
        }
        sessionStorage.removeItem("current_org");
        window.location.href = "/login/";
    }
</script>
{% block scripts %}{% endblock %}
</body>
</html>
s